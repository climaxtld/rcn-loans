<ngx-spinner bdColor="rgba(0,0,0,.3)" size="medium" color="#fff" type="ball-clip-rotate-multiple"></ngx-spinner>

<div class="loan-detail" *ngIf="loan !== undefined">
  <div class="header-container flex-container">
    <div class="flex-item">
      <app-goback-button></app-goback-button>
    </div>
    <div class="flex-item">
      <div class="creator-container">
        <div class="creator-title">{{ brand.header }}</div>
      </div>
    </div>
    <div class="flex-item">
      <ng-container *ngIf="generatedByUser === undefined; else buttonGroup">
        <i class="fa fa-spinner fa-lg fa-spin"></i>
      </ng-container>
      <ng-template #buttonGroup>
        <app-button-group (view)="openDetail($event)" [viewDetail]="viewDetail" [generatedByUser]="generatedByUser"></app-button-group>
      </ng-template>
    </div>
  </div>

  <div class="loan-description flex-container">
    <div class="left">
      <div class="avatar-information margintop5 marginbottom20">
        <div class="flex-item">
          <app-loan-avatar [loan]=loan [short]=true></app-loan-avatar>
        </div>
        <div class="flex-item">
          <app-avatar-title [loan]=loan></app-avatar-title>
        </div>
      </div>
      <div class="paddingleft15 paddingright15">
        <app-conversion-graphic
          [headers]="['Lend', 'Currency', isRequest ? 'Estimated return' : 'Return']"
          [amountLeft]="loan.currency.fromUnit(loan.amount)"
          [textMiddle]="loan.currency"
          [amountRight]="isRequest ? expectedReturn : totalDebt"
        ></app-conversion-graphic>
      </div>
      <div class="paddingleft15 paddingright15" *ngIf="!isRequest">
        <app-conversion-graphic
          [headers]="['Paid', null, 'Debt']"
          [amountRight]="pendingAmount"
          [amountLeft]="paid"
        ></app-conversion-graphic>
      </div>

      <div class="margintop20"></div>

      <!-- loan generated by user -->
      <ng-container [ngSwitch]="generatedByUser">
        <ng-container *ngSwitchCase="true">
          <div class="table-multiple row">
            <div class="col col-6">
              <div class="table">
                <div class="table__head">
                  Interest
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ interest || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col col-6">
              <div class="table">
                <div class="table__head">
                  Duration
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ duration || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="table table--clickable"
            [class.table--active]="isDetail('collateral')"
            (click)="openDetail('collateral');"
          >
            <div class="table__head">
              Collateral
            </div>
            <div class="table__body">
              <div class="row">
                <div class="col">
                  {{ collateralAmount || '-' }} {{ collateralAsset }}
                </div>
              </div>
            </div>
          </div>
          <div class="table table--clickable"
            [class.table--active]="isDetail('installments')"
            (click)="openDetail('installments');"
          >
            <div class="table__head">
              Installments
            </div>
            <div class="table__body">
              <div class="row">
                <div class="col col-3">
                  <span class="subtitle">
                    Installment
                  </span>
                </div>
                <div class="col col-3">
                  <span class="subtitle">
                    Amount to pay
                  </span>
                </div>
                <div class="col col-6">
                  <span class="subtitle">
                    Due date
                    <span *ngIf="nextInstallment?.daysLeft"
                      class="due-status due-status--success">
                      ({{ nextInstallment.daysLeft }} days left)
                    </span>
                    <span *ngIf="nextInstallment?.daysAgo"
                      class="due-status due-status--success">
                      ({{ nextInstallment.daysAgo }} days left)
                    </span>
                  </span>
                </div>
              </div>
              <div class="row">
                <div class="col col-3">
                  {{ nextInstallment?.installment || '-' }}
                </div>
                <div class="col col-3">
                  {{ nextInstallment?.amount || '-' }}
                </div>
                <div class="col col-6">
                  {{ nextInstallment?.dueDate || '-' }}
                </div>
              </div>
            </div>
          </div>

          <div class="table-multiple row">
            <div class="col col-6">
              <div class="table">
                <div class="table__head">
                  Lend Date
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ lendDate || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col col-6">
              <div class="table">
                <div class="table__head">
                  Due Date
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ dueDate || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table">
            <div class="table__head">
              Lender
            </div>
            <div class="table__body">
              <div class="row">
                <div class="col">
                  {{ loan.debt ? loan.debt.owner : 'There´s no lender yet.' }}
                </div>
              </div>
            </div>
          </div>

          <div class="table-multiple row">
            <div class="col col-4">
              <div class="table">
                <div class="table__head">
                  Liquidation Ratio
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ liquidationRatio || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col col-4">
              <div class="table">
                <div class="table__head">
                  Balance Ratio
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ balanceRatio || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col col-4">
              <div class="table">
                <div class="table__head">
                  Punitory
                </div>
                <div class="table__body">
                  <div class="row">
                    <div class="col">
                      {{ punitory || '-' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- loan generated externally -->
        <ng-container *ngSwitchCase="false">
          <app-detail-table [data]="diasporeData" *ngIf="isDiaspore"></app-detail-table>
          <app-detail-table [data]="loanConfigData" *ngIf="isRequest"></app-detail-table>
          <app-detail-table [data]="loanStatusData" *ngIf="!isRequest"></app-detail-table>
          <div class="table-responsive" *ngIf='availableOracle'>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Oracle</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ loan.oracle }} - <b>{{ currency }}</b></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-responsive" (click)="openDetail('identity');">
            <table class="table table-clickable">
              <thead>
                <tr>
                  <th style='cursor: pointer' [ngClass]="{'background-active': isDetail('identity') }" scope="col">
                    Identity
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style='cursor: pointer'>{{ loan.borrower }} - <b>{{ identityName }}</b></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-responsive">
            <table class="table" (click)="openLender(loan.owner)" *ngIf="!isRequest && !isExpired">
              <thead>
                <tr>
                  <th style='cursor: pointer' scope="col">{{ 'Lender' }}</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style='cursor: pointer'>{{ loan.debt.owner }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-responsive" (click)="openDetail('cosigner');">
            <table class="table table-clickable">
              <thead>
                <tr>
                  <th style='cursor: pointer' [ngClass]="{'background-active': isDetail('cosigner') }" scope="col">
                      Insurance / Cosigner
                  </th>
                </tr>
              </thead>
              <tbody>
                <app-cosigner-selector [loan]=loan></app-cosigner-selector>
              </tbody>
            </table>
          </div>
        </ng-container>
      </ng-container>

      <div class="paddingleft15 paddingright15 paddingbottom15" *ngIf="canLend || canTransfer || canPay">
        <app-pay-button [loan]=loan *ngIf="canPay"></app-pay-button>
        <button mat-raised-button class="button button-primary lend" (click)="openDialog()" *ngIf="canLend">Lend</button>
        <app-risk-indicator class='risk-indicator' [loan]=loan *ngIf="canLend"></app-risk-indicator>
        <app-transfer-button [loan]="loan" *ngIf="canTransfer"></app-transfer-button>
      </div>
    </div>

    <div class="right">
      <app-detail-identity
        *ngIf="isDetail('identity')"
        [loan]="loan"
      ></app-detail-identity>
      <app-detail-cosigner
        *ngIf="isDetail('cosigner')"
        [loan]="loan"
      ></app-detail-cosigner>
      <app-detail-collateral
        *ngIf="isDetail('collateral')"
        [loan]="loan"
        [collateral]="collateral"
        [canAdjust]="canAdjustCollateral"
        (updateCollateral)="updateCollateral($event)"
      ></app-detail-collateral>
      <app-detail-installments
        *ngIf="isDetail('installments')"
        [loan]="loan"
      ></app-detail-installments>
    </div>

  </div>

  <div *ngIf="hasHistory">
    <div class="margintop40"></div>
    <div class="title main-h1 feature-padding">History</div>
    <div class="paddingleft15 paddingright15">
      <app-transaction-history [loan]=loan></app-transaction-history>
    </div>
  </div>
</div>
